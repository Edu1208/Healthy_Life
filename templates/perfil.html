{% extends "base.html" %}
{% block title %}Mi Perfil - Healthy Life{% endblock %}
{% block content %}
<div class="container py-4">
  <!-- Header del Perfil -->
  <div class="profile-header p-4 mb-4">
    <div class="row align-items-center">
      <div class="col-auto">
        <div class="achievement-badge bg-white text-success">
          <i class="bi bi-person-fill"></i>
        </div>
      </div>
      <div class="col">
        <h1 class="h3 mb-1" id="nombreUsuario">Cargando...</h1>
        <p class="mb-0 opacity-75">ID: <span id="idUsuario">-</span></p>
      </div>
      <div class="col-auto">
        <button class="btn btn-light btn-sm" onclick="editarPerfil()">
          <i class="bi bi-pencil me-1"></i>Editar
        </button>
      </div>
    </div>
  </div>

  <!-- Información del Perfil -->
  <div class="row">
    <div class="col-lg-8">
      <!-- Descripción -->
      <div class="card stats-card mb-4">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-journal-text text-info me-2"></i>Descripción
          </h5>
        </div>
        <div class="card-body">
          <p class="card-text" id="descripcionPerfil">
            Cargando información del perfil...
          </p>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <!-- Acciones Rápidas -->
      <div class="card stats-card">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-lightning text-primary me-2"></i>Acciones Rápidas
          </h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button class="btn btn-outline-primary" onclick="editarPerfil()">
              <i class="bi bi-pencil me-2"></i>Editar Perfil
            </button>
            <button class="btn btn-outline-info" onclick="exportarDatos()">
              <i class="bi bi-download me-2"></i>Exportar Datos
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Editar Perfil -->
<div class="modal fade" id="modalEditarPerfil" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar Perfil</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formEditarPerfil">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" id="inputNombre" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Descripción</label>
            <textarea class="form-control" id="textareaDescripcion" rows="4"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" onclick="guardarPerfil()">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', function() {
  cargarPerfil();
});

function cargarPerfil() {
  fetch('/perfil/datos')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        mostrarPerfil(data.perfil);
      } else {
        mostrarMensaje('Error al cargar el perfil', 'danger');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      mostrarMensaje('Error al cargar el perfil', 'danger');
    });
}

function mostrarPerfil(perfil) {
  document.getElementById('nombreUsuario').textContent = perfil.nombre || 'Usuario';
  document.getElementById('idUsuario').textContent = perfil._id || '-';
  document.getElementById('descripcionPerfil').textContent = perfil.descripcion || 'Sin descripción';
}

function editarPerfil() {
  fetch('/perfil/datos')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const perfil = data.perfil;
        document.getElementById('inputNombre').value = perfil.nombre || '';
        document.getElementById('textareaDescripcion').value = perfil.descripcion || '';
        
        const modal = new bootstrap.Modal(document.getElementById('modalEditarPerfil'));
        modal.show();
      }
    })
    .catch(error => {
      console.error('Error:', error);
      mostrarMensaje('Error al cargar datos del perfil', 'danger');
    });
}

function guardarPerfil() {
  const nombre = document.getElementById('inputNombre').value.trim();
  const descripcion = document.getElementById('textareaDescripcion').value.trim();

  fetch('/perfil/editar', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      nombre: nombre,
      descripcion: descripcion
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarPerfil'));
      modal.hide();
      cargarPerfil();
      mostrarMensaje('Perfil actualizado correctamente', 'success');
    } else {
      mostrarMensaje(data.message, 'danger');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    mostrarMensaje('Error al actualizar el perfil', 'danger');
  });
}

function exportarDatos() {
  fetch('/exportar-datos')
    .then(response => response.blob())
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = 'healthy_life_datos.json';
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      mostrarMensaje('Datos exportados correctamente', 'success');
    })
    .catch(error => {
      console.error('Error:', error);
      mostrarMensaje('Error al exportar datos', 'danger');
    });
}

function mostrarMensaje(mensaje, tipo) {
  const alerta = document.createElement('div');
  alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
  alerta.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
  alerta.innerHTML = `
    ${mensaje}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(alerta);
  
  setTimeout(() => {
    if (alerta.parentNode) alerta.remove();
  }, 3000);
}
</script>

<style>
.profile-header {
  background: linear-gradient(135deg, #198754, #20c997);
  border-radius: 12px;
  color: white;
}

.stats-card {
  border: none;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.achievement-badge {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %}
