{% extends "base.html" %}
{% block title %}Mi Perfil - Healthy Life{% endblock %}
{% block content %}
<div class="container py-4">
  <!-- Header del Perfil -->
  <div class="profile-header p-4 mb-4">
    <div class="row align-items-center">
      <div class="col-auto">
        <div class="achievement-badge bg-white text-success">
          <i class="bi bi-person-fill"></i>
        </div>
      </div>
      <div class="col">
        <h1 class="h3 mb-1" id="nombreUsuario">{{ usuario.nombre if usuario else 'Usuario' }}</h1>
        <p class="mb-0 opacity-75">ID: <span id="idUsuario">{{ usuario._id|string if usuario else 'N/A' }}</span></p>
      </div>
      <div class="col-auto">
        <button class="btn btn-light btn-sm" onclick="editarPerfil()">
          <i class="bi bi-pencil me-1"></i>Editar
        </button>
      </div>
    </div>
  </div>

  <!-- Estad√≠sticas Principales -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="stats-card bg-white p-3 text-center">
        <div class="text-warning mb-2">
          <i class="bi bi-fire fs-1"></i>
        </div>
        <h4 class="text-warning mb-1" id="rachaPerfil">{{ racha.dias_consecutivos if racha else 0 }}</h4>
        <p class="text-muted mb-0">Racha Actual</p>
      </div>
    </div>
    <div class="col-md-4">
      <div class="stats-card bg-white p-3 text-center">
        <div class="text-primary mb-2">
          <i class="bi bi-dumbbell fs-1"></i>
        </div>
        <h4 class="text-primary mb-1" id="especialidadPerfil">{{ perfil.especialidad if perfil else 'General' }}</h4>
        <p class="text-muted mb-0">Especialidad</p>
      </div>
    </div>
    <div class="col-md-4">
      <div class="stats-card bg-white p-3 text-center">
        <div class="text-success mb-2">
          <i class="bi bi-calendar-check fs-1"></i>
        </div>
        <h4 class="text-success mb-1" id="fechaRegistro">
          {{ usuario.fecha_registro.strftime('%d/%m/%Y') if usuario and usuario.fecha_registro else 'N/A' }}
        </h4>
        <p class="text-muted mb-0">Cuenta Creada</p>
      </div>
    </div>
  </div>

  <!-- Informaci√≥n del Perfil -->
  <div class="row">
    <div class="col-lg-8">
      <!-- Descripci√≥n -->
      <div class="card stats-card mb-4">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-journal-text text-info me-2"></i>Descripci√≥n
          </h5>
        </div>
        <div class="card-body">
          <p class="card-text" id="descripcionPerfil">
            {{ perfil.descripcion if perfil else 'Apasionado del fitness y el desarrollo personal. Mi objetivo es mantener una vida saludable mientras ayudo a otros en su journey fitness.' }}
          </p>
          <div class="mt-3" id="etiquetasPerfil">
            {% if perfil and perfil.etiquetas %}
              {% for etiqueta in perfil.etiquetas %}
                <span class="badge bg-primary me-2">#{{ etiqueta }}</span>
              {% endfor %}
            {% else %}
              <span class="badge bg-primary me-2">#Fitness</span>
              <span class="badge bg-success me-2">#Salud</span>
              <span class="badge bg-warning me-2">#Bienestar</span>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Estad√≠sticas Adicionales -->
      <div class="card stats-card">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-graph-up text-success me-2"></i>Estad√≠sticas
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-4">
              <h4 class="text-primary">{{ total_rutinas }}</h4>
              <p class="text-muted mb-0">Rutinas Creadas</p>
            </div>
            <div class="col-md-4">
              <h4 class="text-success">{{ total_notas }}</h4>
              <p class="text-muted mb-0">Notas</p>
            </div>
            <div class="col-md-4">
              <h4 class="text-warning">{{ racha.record_personal if racha else 0 }}</h4>
              <p class="text-muted mb-0">R√©cord Personal</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <!-- Rutinas Recientes -->
      <div class="card stats-card mb-4">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-list-check text-success me-2"></i>Rutinas Recientes
          </h5>
        </div>
        <div class="card-body" id="rutinasRecientes">
          <div class="text-center text-muted py-3">
            <i class="bi bi-info-circle me-2"></i>No hay rutinas recientes
            <br>
            <small><a href="{{ url_for('nuevo') }}">Crear una rutina</a></small>
          </div>
        </div>
      </div>

      <!-- Acciones R√°pidas -->
      <div class="card stats-card">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-lightning text-primary me-2"></i>Acciones R√°pidas
          </h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button class="btn btn-outline-primary" onclick="editarPerfil()">
              <i class="bi bi-pencil me-2"></i>Editar Perfil
            </button>
            <button class="btn btn-outline-success" onclick="compartirProgreso()">
              <i class="bi bi-share me-2"></i>Compartir Progreso
            </button>
            <a href="{{ url_for('racha') }}" class="btn btn-outline-warning">
              <i class="bi bi-fire me-2"></i>Ver Mi Racha
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Editar Perfil -->
<div class="modal fade" id="modalEditarPerfil" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar Perfil</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formEditarPerfil">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Nombre de usuario</label>
                <input type="text" class="form-control" id="inputNombreUsuario" value="{{ usuario.nombre if usuario else '' }}">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Especialidad</label>
                <select class="form-select" id="selectEspecialidad">
                  <option value="Fuerza" {% if perfil and perfil.especialidad == 'Fuerza' %}selected{% endif %}>Fuerza</option>
                  <option value="Cardio" {% if perfil and perfil.especialidad == 'Cardio' %}selected{% endif %}>Cardio</option>
                  <option value="Velocidad" {% if perfil and perfil.especialidad == 'Velocidad' %}selected{% endif %}>Velocidad</option>
                  <option value="Flexibilidad" {% if perfil and perfil.especialidad == 'Flexibilidad' %}selected{% endif %}>Flexibilidad</option>
                  <option value="General" {% if not perfil or perfil.especialidad == 'General' %}selected{% endif %}>General</option>
                </select>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Descripci√≥n</label>
            <textarea class="form-control" id="textareaDescripcion" rows="4">{{ perfil.descripcion if perfil else '' }}</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Etiquetas (separadas por comas)</label>
            <input type="text" class="form-control" id="inputEtiquetas" 
                   value="{% if perfil and perfil.etiquetas %}{{ perfil.etiquetas|join(', ') }}{% else %}Fitness, Salud, Bienestar{% endif %}" 
                   placeholder="Ej: Fuerza, Consistencia, Salud">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" onclick="guardarPerfil()">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function editarPerfil() {
  const modal = new bootstrap.Modal(document.getElementById('modalEditarPerfil'));
  modal.show();
}

function guardarPerfil() {
  const nombre = document.getElementById('inputNombreUsuario').value.trim();
  const especialidad = document.getElementById('selectEspecialidad').value;
  const descripcion = document.getElementById('textareaDescripcion').value.trim();
  const etiquetasInput = document.getElementById('inputEtiquetas').value.trim();
  
  const etiquetas = etiquetasInput ? etiquetasInput.split(',').map(e => e.trim()).filter(e => e) : [];

  const datosPerfil = {
    nombre: nombre,
    especialidad: especialidad,
    descripcion: descripcion,
    etiquetas: etiquetas
  };

  fetch('/perfil/actualizar', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(datosPerfil)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      mostrarMensaje(data.message, 'success');
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } else {
      mostrarMensaje(data.message, 'danger');
    }
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarPerfil'));
    modal.hide();
  })
  .catch(error => {
    console.error('Error:', error);
    mostrarMensaje('Error al actualizar el perfil', 'danger');
  });
}

function compartirProgreso() {
  const rachaActual = {{ racha.dias_consecutivos if racha else 0 }};
  const nombreUsuario = '{{ usuario.nombre if usuario else "Usuario" }}';
  const especialidad = '{{ perfil.especialidad if perfil else "General" }}';
  
  const texto = `¬°Hola! Soy ${nombreUsuario} y llevo ${rachaActual} d√≠as consecutivos entrenando con Healthy Life. Mi especialidad: ${especialidad}. ¬°√önete a mi journey fitness! üí™ #HealthyLife #${especialidad}`;
  
  if (navigator.share) {
    navigator.share({
      title: 'Mi Progreso en Healthy Life',
      text: texto,
      url: window.location.href
    });
  } else {
    navigator.clipboard.writeText(texto).then(() => {
      mostrarMensaje('¬°Texto copiado al portapapeles! Comparte tu progreso.', 'success');
    });
  }
}

function mostrarMensaje(mensaje, tipo) {
  const alerta = document.createElement('div');
  alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
  alerta.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
  alerta.innerHTML = `
    ${mensaje}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(alerta);
  
  setTimeout(() => {
    if (alerta.parentNode) alerta.remove();
  }, 3000);
}

// Cargar rutinas recientes al iniciar
document.addEventListener('DOMContentLoaded', function() {
  cargarRutinasRecientes();
});

function cargarRutinasRecientes() {
  fetch('/historial-rutinas-data')
    .then(response => response.json())
    .then(data => {
      if (data.success && data.rutinas.length > 0) {
        const rutinasContainer = document.getElementById('rutinasRecientes');
        const rutinasRecientes = data.rutinas.slice(0, 3);
        
        let rutinasHTML = '';
        rutinasRecientes.forEach(rutina => {
          const estadoColor = rutina.estado === 'completada' ? 'bg-success' : 
                            rutina.estado === 'en-progreso' ? 'bg-info' : 'bg-secondary';
          
          rutinasHTML += `
            <div class="mb-3">
              <h6 class="mb-1">${rutina.nombre}</h6>
              <div class="d-flex justify-content-between align-items-center">
                <span class="badge ${estadoColor}">${rutina.estado}</span>
                <small class="text-muted">${rutina.duracion || 0} min</small>
              </div>
            </div>
          `;
        });
        
        rutinasContainer.innerHTML = rutinasHTML;
      }
    })
    .catch(error => {
      console.error('Error al cargar rutinas recientes:', error);
    });
}
</script>

<style>
.profile-header {
  background: linear-gradient(135deg, #198754, #20c997);
  color: white;
  border-radius: 12px;
}

.achievement-badge {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
}

.stats-card {
  border: none;
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.05);
  transition: all 0.3s ease;
}

.stats-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}
</style>
{% endblock %}
