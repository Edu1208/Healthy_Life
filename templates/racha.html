{% extends "base.html" %}
{% block title %}Mi Racha - Healthy Life{% endblock %}
{% block content %}
<div class="container py-4">
  <!-- Header Principal de Racha -->
  <div class="row justify-content-center mb-5">
    <div class="col-lg-10">
      <div class="streak-hero-card text-center position-relative overflow-hidden">
        <div class="streak-background"></div>
        <div class="position-relative z-2 py-5">
          <div class="streak-flame-container mb-4">
            <div class="streak-flame-main">
              <i class="bi bi-fire"></i>
            </div>
            {% if racha and racha.dias_consecutivos >= 7 %}
            <div class="flame-particles">
              <div class="particle particle-1"></div>
              <div class="particle particle-2"></div>
              <div class="particle particle-3"></div>
            </div>
            {% endif %}
          </div>
          
          <h1 class="display-2 fw-bold text-white mb-2 streak-counter" id="diasConsecutivos">
            {{ racha.dias_consecutivos if racha else 0 }}
          </h1>
          <h3 class="text-white mb-3">DÃ­as Consecutivos</h3>
          
          <!-- Mensaje Motivacional DinÃ¡mico -->
          <div class="motivational-message mb-4">
            <p class="lead text-white" id="mensajeRacha">
              {% if not racha or racha.dias_consecutivos == 0 %}
              <i class="bi bi-rocket-takeoff me-2"></i>Â¡Comienza tu aventura fitness hoy!
              {% elif racha.dias_consecutivos < 3 %}
              <i class="bi bi-emoji-smile me-2"></i>Â¡Buen comienzo! Sigue asÃ­.
              {% elif racha.dias_consecutivos < 7 %}
              <i class="bi bi-star me-2"></i>Â¡Vas por buen camino! Constancia es clave.
              {% elif racha.dias_consecutivos < 14 %}
              <i class="bi bi-lightning me-2"></i>Â¡Impresionante! Una semana completa.
              {% elif racha.dias_consecutivos < 30 %}
              <i class="bi bi-trophy me-2"></i>Â¡Espectacular! MÃ¡s de dos semanas.
              {% else %}
              <i class="bi bi-award me-2"></i>Â¡Leyenda! MÃ¡s de un mes de consistencia.
              {% endif %}
            </p>
          </div>

          <!-- EstadÃ­sticas Principales -->
          <div class="row justify-content-center">
            <div class="col-md-3 col-6 mb-3">
              <div class="stat-card">
                <div class="stat-icon text-success">
                  <i class="bi bi-fire"></i>
                </div>
                <h4 class="stat-number text-white mb-1" id="rachaActual">{{ racha.dias_consecutivos if racha else 0 }}</h4>
                <small class="text-white-50">Racha Actual</small>
              </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="stat-card">
                <div class="stat-icon text-primary">
                  <i class="bi bi-graph-up-arrow"></i>
                </div>
                <h4 class="stat-number text-white mb-1" id="recordPersonal">{{ racha.record_personal if racha else 0 }}</h4>
                <small class="text-white-50">RÃ©cord Personal</small>
              </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="stat-card">
                <div class="stat-icon text-info">
                  <i class="bi bi-calendar-check"></i>
                </div>
                <h4 class="stat-number text-white mb-1" id="totalDias">{{ racha.dias_completados|length if racha and racha.dias_completados else 0 }}</h4>
                <small class="text-white-50">DÃ­as Activos</small>
              </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="stat-card">
                <div class="stat-icon text-warning">
                  <i class="bi bi-percent"></i>
                </div>
                <h4 class="stat-number text-white mb-1" id="tasaExito">0%</h4>
                <small class="text-white-50">Tasa de Ã‰xito</small>
              </div>
            </div>
          </div>

          <!-- BotÃ³n de AcciÃ³n Principal -->
          <div class="mt-4">
            <button class="btn btn-lg btn-success glow-button" onclick="marcarDiaHoy()" id="btnMarcarHoy">
              <i class="bi bi-check-circle me-2"></i>
              <span id="btnTexto">Marcar DÃ­a de Hoy</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- SecciÃ³n Izquierda: Calendario y Progreso -->
    <div class="col-lg-8">
      <!-- Calendario de Progreso -->
      <div class="streak-section-card">
        <div class="section-header">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
              <i class="bi bi-calendar3 text-primary me-2"></i>Calendario de Progreso
            </h4>
            <div class="d-flex align-items-center">
              <button class="btn btn-sm btn-outline-secondary me-2" onclick="cambiarMes(-1)" id="btnMesAnterior">
                <i class="bi bi-chevron-left"></i>
              </button>
              <span class="badge bg-success fs-6" id="mesActual">Cargando...</span>
              <button class="btn btn-sm btn-outline-secondary ms-2" onclick="cambiarMes(1)" id="btnMesSiguiente">
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- DÃ­as de la semana -->
        <div class="calendar-weekdays mb-3">
          <div class="weekday"><small class="fw-bold text-muted">Lun</small></div>
          <div class="weekday"><small class="fw-bold text-muted">Mar</small></div>
          <div class="weekday"><small class="fw-bold text-muted">MiÃ©</small></div>
          <div class="weekday"><small class="fw-bold text-muted">Jue</small></div>
          <div class="weekday"><small class="fw-bold text-muted">Vie</small></div>
          <div class="weekday"><small class="fw-bold text-muted">SÃ¡b</small></div>
          <div class="weekday"><small class="fw-bold text-muted">Dom</small></div>
        </div>

        <!-- Contenedor del Calendario -->
        <div id="calendarioContainer" class="calendar-grid">
          <!-- El calendario se generarÃ¡ dinÃ¡micamente -->
        </div>

        <!-- Leyenda del Calendario -->
        <div class="calendar-legend mt-4">
          <div class="row text-center">
            <div class="col-md-3">
              <div class="legend-item">
                <div class="legend-color completed"></div>
                <small>Completado</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="legend-item">
                <div class="legend-color current"></div>
                <small>Hoy</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="legend-item">
                <div class="legend-color future"></div>
                <small>PrÃ³ximo</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="legend-item">
                <div class="legend-color missed"></div>
                <small>Perdido</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- GrÃ¡fico de Progreso Mensual -->
      <div class="streak-section-card mt-4">
        <div class="section-header">
          <h4 class="mb-0">
            <i class="bi bi-graph-up text-success me-2"></i>Progreso Mensual
          </h4>
        </div>
        <div class="progress-bars-container">
          <div class="progress-item">
            <div class="d-flex justify-content-between mb-1">
              <small>Consistencia</small>
              <small id="consistenciaMensual">0%</small>
            </div>
            <div class="progress">
              <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                   id="barraConsistencia" style="width: 0%"></div>
            </div>
          </div>
          <div class="progress-item">
            <div class="d-flex justify-content-between mb-1">
              <small>DÃ­as Activos</small>
              <small id="diasActivos">0/0</small>
            </div>
            <div class="progress">
              <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                   id="barraDiasActivos" style="width: 0%"></div>
            </div>
          </div>
          <div class="progress-item">
            <div class="d-flex justify-content-between mb-1">
              <small>Metas Alcanzadas</small>
              <small id="metasAlcanzadas">0/0</small>
            </div>
            <div class="progress">
              <div class="progress-bar bg-warning progress-bar-striped progress-bar-animated" 
                   id="barraMetas" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SecciÃ³n Derecha: Hitos y Acciones -->
    <div class="col-lg-4">
      <!-- PrÃ³ximos Hitos -->
      <div class="streak-section-card">
        <div class="section-header">
          <h5 class="mb-0">
            <i class="bi bi-flag text-success me-2"></i>PrÃ³ximos Hitos
          </h5>
        </div>
        <div id="listaHitos" class="milestones-container">
          <!-- Los hitos se cargarÃ¡n dinÃ¡micamente -->
        </div>
      </div>

      <!-- Logros Desbloqueados -->
      <div class="streak-section-card mt-4">
        <div class="section-header">
          <h5 class="mb-0">
            <i class="bi bi-trophy text-warning me-2"></i>Logros
          </h5>
        </div>
        <div id="listaLogros" class="achievements-container">
          <!-- Los logros se cargarÃ¡n dinÃ¡micamente -->
        </div>
      </div>

      <!-- Acciones RÃ¡pidas -->
      <div class="streak-section-card mt-4">
        <div class="section-header">
          <h5 class="mb-0">
            <i class="bi bi-lightning text-primary me-2"></i>Acciones RÃ¡pidas
          </h5>
        </div>
        <div class="actions-container">
          <button class="btn btn-outline-success w-100 mb-2" onclick="marcarDiaHoy()">
            <i class="bi bi-check-circle me-2"></i>Marcar Hoy
          </button>
          <button class="btn btn-outline-primary w-100 mb-2" onclick="compartirRacha()">
            <i class="bi bi-share me-2"></i>Compartir Racha
          </button>
          <button class="btn btn-outline-info w-100 mb-2" onclick="configurarRecordatorio()">
            <i class="bi bi-bell me-2"></i>Recordatorios
          </button>
          <button class="btn btn-outline-warning w-100" onclick="verEstadisticasCompletas()">
            <i class="bi bi-graph-up-arrow me-2"></i>EstadÃ­sticas Completas
          </button>
        </div>
      </div>

      <!-- Tips de MotivaciÃ³n -->
      <div class="streak-section-card mt-4">
        <div class="section-header">
          <h5 class="mb-0">
            <i class="bi bi-lightbulb text-info me-2"></i>Tip del DÃ­a
          </h5>
        </div>
        <div class="tip-content">
          <p id="tipDelDia" class="mb-0">La consistencia es mÃ¡s importante que la intensidad. Â¡PequeÃ±os pasos diarios llevan a grandes resultados!</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de ConfiguraciÃ³n de Recordatorio -->
<div class="modal fade" id="modalRecordatorio" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-bell text-primary me-2"></i>Configurar Recordatorio
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-medium">Hora del recordatorio</label>
          <input type="time" class="form-control" id="horaRecordatorio" 
                 value="{{ racha.recordatorio.hora if racha and racha.recordatorio else '19:00' }}">
        </div>
        <div class="mb-3">
          <label class="form-label fw-medium">Frecuencia</label>
          <select class="form-select" id="frecuenciaRecordatorio">
            <option value="diario" selected>Diario</option>
            <option value="lunes_viernes">Lunes a Viernes</option>
            <option value="fin_semana">Fin de Semana</option>
          </select>
        </div>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="recordatorioActivo" 
                 {% if racha and racha.recordatorio and racha.recordatorio.activo %}checked{% endif %}>
          <label class="form-check-label" for="recordatorioActivo">
            Recordatorio activo
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" onclick="guardarRecordatorio()">
          <i class="bi bi-check-lg me-1"></i>Guardar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de EstadÃ­sticas Completas -->
<div class="modal fade" id="modalEstadisticas" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-graph-up-arrow text-success me-2"></i>EstadÃ­sticas Completas
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="stat-card-modal">
              <h6>Racha Actual</h6>
              <h3 class="text-success" id="modalRachaActual">0</h3>
            </div>
          </div>
          <div class="col-md-6">
            <div class="stat-card-modal">
              <h6>RÃ©cord Personal</h6>
              <h3 class="text-primary" id="modalRecordPersonal">0</h3>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6">
            <div class="stat-card-modal">
              <h6>Total de DÃ­as Activos</h6>
              <h3 class="text-info" id="modalTotalDias">0</h3>
            </div>
          </div>
          <div class="col-md-6">
            <div class="stat-card-modal">
              <h6>Tasa de Ã‰xito</h6>
              <h3 class="text-warning" id="modalTasaExito">0%</h3>
            </div>
          </div>
        </div>
        <div class="mt-4">
          <h6>Progreso por Mes</h6>
          <div id="graficoMensual" class="mt-3">
            <!-- GrÃ¡fico se generarÃ¡ dinÃ¡micamente -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Variables globales
let datosRacha = {{ racha|tojson if racha else '{}' }};
let mesActual = new Date();
let tipsMotivacionales = [
  "Â¡Cada dÃ­a cuenta! PequeÃ±os pasos llevan a grandes resultados.",
  "La consistencia es la clave del Ã©xito. Â¡Sigue adelante!",
  "Hoy es un buen dÃ­a para ser mejor que ayer.",
  "El esfuerzo de hoy es la recompensa de maÃ±ana.",
  "No te rindas. Generalmente es la Ãºltima llave la que abre la puerta.",
  "Tu Ãºnico lÃ­mite es tu mente. Â¡Sigue desafiÃ¡ndote!",
  "El progreso, no la perfecciÃ³n. Â¡Celebra cada avance!",
  "Los hÃ¡bitos se construyen dÃ­a a dÃ­a. Â¡TÃº puedes!",
  "La disciplina tarde o temprano vencerÃ¡ a la inteligencia.",
  "Hoy es tu oportunidad de construir el maÃ±ana que deseas."
];

// InicializaciÃ³n
document.addEventListener('DOMContentLoaded', function() {
  if (Object.keys(datosRacha).length === 0) {
    cargarDatosRacha();
  } else {
    inicializarRacha();
  }
  
  // Mostrar tip aleatorio
  mostrarTipAleatorio();
});

function inicializarRacha() {
  actualizarRacha();
  generarCalendario();
  actualizarEstadisticas();
  actualizarHitos();
  actualizarLogros();
  verificarEstadoHoy();
}

function cargarDatosRacha() {
  fetch('/racha/datos')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        datosRacha = data.racha;
        inicializarRacha();
      } else {
        console.error('Error al cargar datos de racha:', data.message);
        mostrarMensaje('Error al cargar los datos de racha', 'danger');
      }
    })
    .catch(error => {
      console.error('Error al cargar datos de racha:', error);
      mostrarMensaje('Error de conexiÃ³n al cargar la racha', 'danger');
    });
}

function actualizarRacha() {
  const diasConsecutivos = datosRacha.dias_consecutivos || 0;
  
  // Actualizar contadores
  document.getElementById('diasConsecutivos').textContent = diasConsecutivos;
  document.getElementById('rachaActual').textContent = diasConsecutivos;
  document.getElementById('recordPersonal').textContent = datosRacha.record_personal || 0;
  document.getElementById('totalDias').textContent = datosRacha.dias_completados ? datosRacha.dias_completados.length : 0;
  
  // Actualizar tasa de Ã©xito
  const tasaExito = calcularTasaExito();
  document.getElementById('tasaExito').textContent = tasaExito + '%';
  
  // Actualizar mensaje motivacional
  actualizarMensajeMotivacional(diasConsecutivos);
  
  // Actualizar animaciones basadas en la racha
  actualizarAnimacionesRacha(diasConsecutivos);
}

function actualizarMensajeMotivacional(dias) {
  const mensajes = {
    0: '<i class="bi bi-rocket-takeoff me-2"></i>Â¡Comienza tu aventura fitness hoy!',
    1: '<i class="bi bi-emoji-smile me-2"></i>Â¡Buen comienzo! Sigue asÃ­.',
    2: '<i class="bi bi-star me-2"></i>Â¡Vas por buen camino! Constancia es clave.',
    7: '<i class="bi bi-lightning me-2"></i>Â¡Impresionante! Una semana completa.',
    14: '<i class="bi bi-trophy me-2"></i>Â¡Espectacular! MÃ¡s de dos semanas.',
    30: '<i class="bi bi-award me-2"></i>Â¡Leyenda! MÃ¡s de un mes de consistencia.'
  };
  
  let mensaje = mensajes[0];
  for (const [diasKey, msg] of Object.entries(mensajes)) {
    if (dias >= parseInt(diasKey)) {
      mensaje = msg;
    }
  }
  
  document.getElementById('mensajeRacha').innerHTML = mensaje;
}

function actualizarAnimacionesRacha(dias) {
  const flameContainer = document.querySelector('.streak-flame-container');
  const counter = document.querySelector('.streak-counter');
  
  // Resetear animaciones
  flameContainer.classList.remove('flame-burn', 'flame-super-burn');
  counter.classList.remove('pulse-animation', 'super-pulse');
  
  // Aplicar animaciones basadas en dÃ­as
  if (dias >= 7) {
    flameContainer.classList.add('flame-burn');
    counter.classList.add('pulse-animation');
  }
  
  if (dias >= 30) {
    flameContainer.classList.add('flame-super-burn');
    counter.classList.add('super-pulse');
  }
}

function marcarDiaHoy() {
  const btn = document.getElementById('btnMarcarHoy');
  const btnTexto = document.getElementById('btnTexto');
  
  // Mostrar estado de carga
  btn.disabled = true;
  btnTexto.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Marcando...';
  
  fetch('/racha/marcar-dia', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      mostrarMensaje(data.message, 'success');
      
      // Actualizar datos locales
      datosRacha.dias_consecutivos = data.nueva_racha;
      datosRacha.record_personal = data.record_personal;
      
      // Agregar dÃ­a actual a dÃ­as completados
      const hoy = new Date();
      const hoyStr = hoy.toISOString().split('T')[0];
      if (!datosRacha.dias_completados) {
        datosRacha.dias_completados = [];
      }
      if (!datosRacha.dias_completados.includes(hoyStr)) {
        datosRacha.dias_completados.push(hoyStr);
      }
      
      // Actualizar interfaz
      actualizarRacha();
      generarCalendario();
      actualizarEstadisticas();
      actualizarHitos();
      actualizarLogros();
      
      // Efecto de celebraciÃ³n para rachas significativas
      if (data.nueva_racha % 7 === 0) {
        mostrarEfectoCelebracion();
      }
      
    } else {
      mostrarMensaje(data.message, 'warning');
    }
    
    // Restaurar botÃ³n
    setTimeout(() => {
      btn.disabled = false;
      btnTexto.textContent = 'Marcar DÃ­a de Hoy';
      verificarEstadoHoy();
    }, 1000);
  })
  .catch(error => {
    console.error('Error:', error);
    mostrarMensaje('Error al marcar el dÃ­a', 'danger');
    
    // Restaurar botÃ³n
    btn.disabled = false;
    btnTexto.textContent = 'Marcar DÃ­a de Hoy';
  });
}

function verificarEstadoHoy() {
  const hoy = new Date();
  const hoyStr = hoy.toISOString().split('T')[0];
  const btn = document.getElementById('btnMarcarHoy');
  const btnTexto = document.getElementById('btnTexto');
  
  if (datosRacha.dias_completados && datosRacha.dias_completados.includes(hoyStr)) {
    btn.disabled = true;
    btn.classList.remove('btn-success');
    btn.classList.add('btn-secondary');
    btnTexto.innerHTML = '<i class="bi bi-check2-all me-2"></i>Â¡Hoy Completado!';
  } else {
    btn.disabled = false;
    btn.classList.remove('btn-secondary');
    btn.classList.add('btn-success');
    btnTexto.textContent = 'Marcar DÃ­a de Hoy';
  }
}

function generarCalendario() {
  const container = document.getElementById('calendarioContainer');
  if (!container) return;
  
  const aÃ±o = mesActual.getFullYear();
  const mes = mesActual.getMonth();
  
  const primerDiaMes = new Date(aÃ±o, mes, 1);
  const ultimoDiaMes = new Date(aÃ±o, mes + 1, 0);
  const diasEnMes = ultimoDiaMes.getDate();
  
  // Actualizar mes actual en la interfaz
  const mesActualElement = document.getElementById('mesActual');
  if (mesActualElement) {
    mesActualElement.textContent = mesActual.toLocaleDateString('es-ES', { 
      month: 'long', 
      year: 'numeric' 
    });
  }
  
  // Calcular dÃ­a de la semana del primer dÃ­a (0 = Domingo, 1 = Lunes, ...)
  let primerDiaSemana = primerDiaMes.getDay();
  primerDiaSemana = primerDiaSemana === 0 ? 6 : primerDiaSemana - 1; // Ajustar para que Lunes = 0
  
  let calendarioHTML = '';
  let fechaActual = new Date(primerDiaMes);
  fechaActual.setDate(fechaActual.getDate() - primerDiaSemana);
  
  // Generar 6 semanas (42 dÃ­as)
  for (let semana = 0; semana < 6; semana++) {
    for (let dia = 0; dia < 7; dia++) {
      const fechaStr = fechaActual.toISOString().split('T')[0];
      const esHoy = esMismoDia(fechaActual, new Date());
      const esMesActual = fechaActual.getMonth() === mes;
      const completado = datosRacha.dias_completados && datosRacha.dias_completados.includes(fechaStr);
      const esFuturo = fechaActual > new Date();
      const esPasado = fechaActual < new Date() && !completado && esMesActual && !esHoy;
      
      let claseDia = 'calendar-day';
      if (completado) {
        claseDia += ' completed';
      } else if (esHoy) {
        claseDia += ' current';
      } else if (esFuturo) {
        claseDia += ' future';
      } else if (esPasado) {
        claseDia += ' missed';
      } else if (!esMesActual) {
        claseDia += ' other-month';
      }
      
      const diaNumero = fechaActual.getDate();
      
      calendarioHTML += `
        <div class="${claseDia}" 
             ${esHoy && !completado ? 'onclick="marcarDiaHoy()" style="cursor: pointer;"' : ''}
             data-fecha="${fechaStr}"
             data-bs-toggle="tooltip" 
             title="${fechaStr}">
          ${diaNumero}
          ${completado ? '<div class="day-check"><i class="bi bi-check"></i></div>' : ''}
        </div>
      `;
      
      fechaActual.setDate(fechaActual.getDate() + 1);
    }
  }
  
  container.innerHTML = calendarioHTML;
  
  // Inicializar tooltips
  const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  tooltips.forEach(tooltip => {
    new bootstrap.Tooltip(tooltip);
  });
}

function cambiarMes(direccion) {
  mesActual.setMonth(mesActual.getMonth() + direccion);
  generarCalendario();
  
  // Deshabilitar botones si es el mes actual o futuro
  const hoy = new Date();
  const btnAnterior = document.getElementById('btnMesAnterior');
  const btnSiguiente = document.getElementById('btnMesSiguiente');
  
  btnSiguiente.disabled = mesActual.getMonth() === hoy.getMonth() && 
                         mesActual.getFullYear() === hoy.getFullYear();
}

function esMismoDia(fecha1, fecha2) {
  return fecha1.getDate() === fecha2.getDate() &&
         fecha1.getMonth() === fecha2.getMonth() &&
         fecha1.getFullYear() === fecha2.getFullYear();
}

function actualizarEstadisticas() {
  const hoy = new Date();
  const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
  const diasEnMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0).getDate();
  
  // Calcular dÃ­as activos este mes
  let diasActivosMes = 0;
  if (datosRacha.dias_completados) {
    diasActivosMes = datosRacha.dias_completados.filter(fecha => {
      const fechaObj = new Date(fecha);
      return fechaObj.getMonth() === hoy.getMonth() && 
             fechaObj.getFullYear() === hoy.getFullYear();
    }).length;
  }
  
  const diasTranscurridos = hoy.getDate();
  const consistencia = diasTranscurridos > 0 ? 
    Math.round((diasActivosMes / diasTranscurridos) * 100) : 0;
  
  const porcentajeDiasActivos = Math.round((diasActivosMes / diasEnMes) * 100);
  
  // Metas (basadas en dÃ­as activos)
  const metasTotales = Math.ceil(diasEnMes * 0.7); // 70% del mes
  const metasCompletadas = Math.min(diasActivosMes, metasTotales);
  
  // Actualizar elementos
  document.getElementById('consistenciaMensual').textContent = consistencia + '%';
  document.getElementById('barraConsistencia').style.width = consistencia + '%';
  
  document.getElementById('diasActivos').textContent = `${diasActivosMes}/${diasEnMes}`;
  document.getElementById('barraDiasActivos').style.width = porcentajeDiasActivos + '%';
  
  document.getElementById('metasAlcanzadas').textContent = `${metasCompletadas}/${metasTotales}`;
  document.getElementById('barraMetas').style.width = Math.round((metasCompletadas / metasTotales) * 100) + '%';
}

function actualizarHitos() {
  const listaHitos = document.getElementById('listaHitos');
  if (!listaHitos) return;
  
  const hitos = datosRacha.hitos || [3, 7, 14, 30, 60, 90];
  const diasConsecutivos = datosRacha.dias_consecutivos || 0;
  
  listaHitos.innerHTML = '';
  
  hitos.forEach(hito => {
    const diasRestantes = hito - diasConsecutivos;
    const porcentaje = Math.min(Math.round((diasConsecutivos / hito) * 100), 100);
    const alcanzado = diasConsecutivos >= hito;
    const proximo = diasRestantes > 0 && diasRestantes <= 7;
    
    let claseHito = 'milestone-item';
    if (alcanzado) claseHito += ' achieved';
    if (proximo) claseHito += ' upcoming';
    
    const hitoHTML = `
      <div class="${claseHito}">
        <div class="milestone-header">
          <div class="milestone-icon">
            ${alcanzado ? 
              '<i class="bi bi-trophy-fill text-warning"></i>' : 
              '<i class="bi bi-flag"></i>'
            }
          </div>
          <div class="milestone-info">
            <h6 class="mb-1">${hito} dÃ­as</h6>
            <small class="milestone-status">
              ${alcanzado ? 
                '<span class="text-success">Â¡Alcanzado!</span>' : 
                (proximo ? 
                  `<span class="text-warning">${diasRestantes} dÃ­as restantes</span>` :
                  `<span class="text-muted">${diasRestantes} dÃ­as restantes</span>`
                )
              }
            </small>
          </div>
        </div>
        <div class="progress mt-2" style="height: 6px;">
          <div class="progress-bar ${alcanzado ? 'bg-warning' : 'bg-success'}" 
               style="width: ${porcentaje}%"></div>
        </div>
      </div>
    `;
    
    listaHitos.innerHTML += hitoHTML;
  });
}

function actualizarLogros() {
  const listaLogros = document.getElementById('listaLogros');
  if (!listaLogros) return;
  
  const diasConsecutivos = datosRacha.dias_consecutivos || 0;
  const logros = [
    { id: 1, nombre: 'Primeros Pasos', descripcion: 'Completa 3 dÃ­as consecutivos', objetivo: 3, icono: 'bi-emoji-smile' },
    { id: 2, nombre: 'Semana de Fuego', descripcion: '7 dÃ­as consecutivos', objetivo: 7, icono: 'bi-fire' },
    { id: 3, nombre: 'Fuerza de Voluntad', descripcion: '14 dÃ­as consecutivos', objetivo: 14, icono: 'bi-heart' },
    { id: 4, nombre: 'Mes de Ã‰xito', descripcion: '30 dÃ­as consecutivos', objetivo: 30, icono: 'bi-trophy' },
    { id: 5, nombre: 'Leyenda Fitness', descripcion: '90 dÃ­as consecutivos', objetivo: 90, icono: 'bi-award' }
  ];
  
  listaLogros.innerHTML = '';
  
  logros.forEach(logro => {
    const desbloqueado = diasConsecutivos >= logro.objetivo;
    const progreso = Math.min(diasConsecutivos, logro.objetivo);
    const porcentaje = Math.round((progreso / logro.objetivo) * 100);
    
    const logroHTML = `
      <div class="achievement-item ${desbloqueado ? 'unlocked' : 'locked'}">
        <div class="achievement-icon">
          <i class="bi ${logro.icono} ${desbloqueado ? 'text-warning' : 'text-muted'}"></i>
        </div>
        <div class="achievement-info">
          <h6 class="mb-1">${logro.nombre}</h6>
          <small class="text-muted">${logro.descripcion}</small>
          ${!desbloqueado ? `
            <div class="progress mt-1" style="height: 4px;">
              <div class="progress-bar bg-info" style="width: ${porcentaje}%"></div>
            </div>
          ` : ''}
        </div>
        ${desbloqueado ? '<div class="achievement-badge"><i class="bi bi-check-lg text-success"></i></div>' : ''}
      </div>
    `;
    
    listaLogros.innerHTML += logroHTML;
  });
}

function calcularTasaExito() {
  if (!datosRacha.dias_completados || datosRacha.dias_completados.length === 0) return 0;
  
  const primerDia = new Date(Math.min(...datosRacha.dias_completados.map(d => new Date(d))));
  const hoy = new Date();
  const diasTotales = Math.ceil((hoy - primerDia) / (1000 * 60 * 60 * 24)) + 1;
  
  return Math.round((datosRacha.dias_completados.length / diasTotales) * 100);
}

function compartirRacha() {
  const diasConsecutivos = datosRacha.dias_consecutivos || 0;
  const recordPersonal = datosRacha.record_personal || 0;
  const totalDias = datosRacha.dias_completados ? datosRacha.dias_completados.length : 0;
  
  const texto = `ðŸ”¥ Â¡Llevo ${diasConsecutivos} dÃ­as consecutivos entrenando con Healthy Life! 
ðŸ’ª Mi rÃ©cord personal: ${recordPersonal} dÃ­as
ðŸ“Š Total de dÃ­as activos: ${totalDias}
âœ¨ Â¡Ãšnete a mi desafÃ­o fitness! 

#HealthyLife #FitnessChallenge #RachaFitness`;

  if (navigator.share) {
    navigator.share({
      title: 'Mi Racha de Entrenamiento - Healthy Life',
      text: texto,
      url: window.location.href
    });
  } else {
    navigator.clipboard.writeText(texto).then(() => {
      mostrarMensaje('Â¡Texto copiado al portapapeles! Comparte tu logro en redes sociales.', 'success');
    });
  }
}

function configurarRecordatorio() {
  const modalElement = document.getElementById('modalRecordatorio');
  if (!modalElement) return;
  
  const horaInput = document.getElementById('horaRecordatorio');
  const activoInput = document.getElementById('recordatorioActivo');
  const frecuenciaInput = document.getElementById('frecuenciaRecordatorio');
  
  if (horaInput) horaInput.value = datosRacha.recordatorio ? datosRacha.recordatorio.hora : '19:00';
  if (activoInput) activoInput.checked = datosRacha.recordatorio ? datosRacha.recordatorio.activo : true;
  if (frecuenciaInput && datosRacha.recordatorio && datosRacha.recordatorio.frecuencia) {
    frecuenciaInput.value = datosRacha.recordatorio.frecuencia;
  }
  
  const modal = new bootstrap.Modal(modalElement);
  modal.show();
}

function guardarRecordatorio() {
  const horaInput = document.getElementById('horaRecordatorio');
  const activoInput = document.getElementById('recordatorioActivo');
  const frecuenciaInput = document.getElementById('frecuenciaRecordatorio');
  
  const recordatorio = {
    activo: activoInput ? activoInput.checked : true,
    hora: horaInput ? horaInput.value : '19:00',
    frecuencia: frecuenciaInput ? frecuenciaInput.value : 'diario'
  };

  fetch('/racha/actualizar-recordatorio', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(recordatorio)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      mostrarMensaje(data.message, 'success');
      // Actualizar datos locales
      if (!datosRacha.recordatorio) {
        datosRacha.recordatorio = {};
      }
      datosRacha.recordatorio.activo = recordatorio.activo;
      datosRacha.recordatorio.hora = recordatorio.hora;
      datosRacha.recordatorio.frecuencia = recordatorio.frecuencia;
    } else {
      mostrarMensaje(data.message, 'danger');
    }
    
    const modalElement = document.getElementById('modalRecordatorio');
    if (modalElement) {
      const modal = bootstrap.Modal.getInstance(modalElement);
      if (modal) modal.hide();
    }
  })
  .catch(error => {
    console.error('Error:', error);
    mostrarMensaje('Error al actualizar el recordatorio', 'danger');
  });
}

function verEstadisticasCompletas() {
  // Actualizar datos en el modal
  document.getElementById('modalRachaActual').textContent = datosRacha.dias_consecutivos || 0;
  document.getElementById('modalRecordPersonal').textContent = datosRacha.record_personal || 0;
  document.getElementById('modalTotalDias').textContent = datosRacha.dias_completados ? datosRacha.dias_completados.length : 0;
  document.getElementById('modalTasaExito').textContent = calcularTasaExito() + '%';
  
  const modal = new bootstrap.Modal(document.getElementById('modalEstadisticas'));
  modal.show();
}

function mostrarTipAleatorio() {
  const tipElement = document.getElementById('tipDelDia');
  if (tipElement && tipsMotivacionales.length > 0) {
    const tipAleatorio = tipsMotivacionales[Math.floor(Math.random() * tipsMotivacionales.length)];
    tipElement.textContent = tipAleatorio;
  }
}

function mostrarEfectoCelebracion() {
  // Crear elementos de confeti
  const colores = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
  
  for (let i = 0; i < 50; i++) {
    setTimeout(() => {
      const confeti = document.createElement('div');
      confeti.className = 'confeti';
      confeti.style.cssText = `
        position: fixed;
        width: 10px;
        height: 10px;
        background: ${colores[Math.floor(Math.random() * colores.length)]};
        top: -10px;
        left: ${Math.random() * 100}%;
        animation: fall-confeti ${2 + Math.random() * 3}s linear forwards;
        z-index: 9999;
        border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
      `;
      
      document.body.appendChild(confeti);
      
      // Remover despuÃ©s de la animaciÃ³n
      setTimeout(() => {
        if (confeti.parentNode) {
          confeti.remove();
        }
      }, 5000);
    }, i * 100);
  }
}

function mostrarMensaje(mensaje, tipo) {
  // Remover mensajes existentes
  const mensajesExistentes = document.querySelectorAll('.alert-position');
  mensajesExistentes.forEach(msg => msg.remove());
  
  const alerta = document.createElement('div');
  alerta.className = `alert alert-${tipo} alert-dismissible fade show alert-position`;
  alerta.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  alerta.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi ${tipo === 'success' ? 'bi-check-circle' : tipo === 'warning' ? 'bi-exclamation-triangle' : 'bi-x-circle'} me-2"></i>
      <span>${mensaje}</span>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(alerta);
  
  // Auto-remover despuÃ©s de 5 segundos
  setTimeout(() => {
    if (alerta.parentNode) {
      alerta.remove();
    }
  }, 5000);
}

// Estilos CSS dinÃ¡micos
const estiloDinamico = document.createElement('style');
estiloDinamico.textContent = `
  /* AnimaciÃ³n de confeti */
  @keyframes fall-confeti {
    0% {
      transform: translateY(0) rotate(0deg);
      opacity: 1;
    }
    100% {
      transform: translateY(100vh) rotate(360deg);
      opacity: 0;
    }
  }
  
  /* AnimaciÃ³n de pulso para la racha */
  @keyframes pulse-glow {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  .pulse-animation {
    animation: pulse-glow 2s infinite;
  }
  
  .super-pulse {
    animation: pulse-glow 1s infinite;
  }
  
  /* PartÃ­culas de fuego */
  .flame-particles {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }
  
  .particle {
    position: absolute;
    background: #ff6b00;
    border-radius: 50%;
    animation: float-particle 3s infinite ease-in-out;
  }
  
  .particle-1 {
    width: 8px;
    height: 8px;
    top: 20%;
    left: 30%;
    animation-delay: 0s;
  }
  
  .particle-2 {
    width: 6px;
    height: 6px;
    top: 10%;
    left: 60%;
    animation-delay: 1s;
  }
  
  .particle-3 {
    width: 4px;
    height: 4px;
    top: 30%;
    left: 80%;
    animation-delay: 2s;
  }
  
  @keyframes float-particle {
    0%, 100% {
      transform: translateY(0) scale(1);
      opacity: 0.7;
    }
    50% {
      transform: translateY(-20px) scale(1.2);
      opacity: 1;
    }
  }
`;
document.head.appendChild(estiloDinamico);
</script>

<style>
/* Estilos principales para la pÃ¡gina de racha */
.streak-hero-card {
  background: linear-gradient(135deg, #ff6b00, #ff8c00, #ffa500);
  border-radius: 20px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(255, 107, 0, 0.3);
}

.streak-background {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: radial-gradient(circle at 30% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
              radial-gradient(circle at 70% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
}

.streak-flame-container {
  position: relative;
  display: inline-block;
}

.streak-flame-main {
  font-size: 5rem;
  color: #fff;
  text-shadow: 0 0 20px rgba(255, 255, 255, 0.5),
               0 0 40px rgba(255, 255, 255, 0.3),
               0 0 60px rgba(255, 255, 255, 0.1);
  animation: flame-flicker 2s infinite alternate;
}

@keyframes flame-flicker {
  0%, 100% {
    transform: scale(1) rotate(0deg);
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.5),
                 0 0 40px rgba(255, 255, 255, 0.3);
  }
  50% {
    transform: scale(1.1) rotate(5deg);
    text-shadow: 0 0 30px rgba(255, 255, 255, 0.7),
                 0 0 50px rgba(255, 255, 255, 0.5),
                 0 0 70px rgba(255, 255, 255, 0.3);
  }
}

.flame-burn .streak-flame-main {
  animation: flame-flicker 1s infinite alternate;
}

.flame-super-burn .streak-flame-main {
  animation: flame-flicker 0.5s infinite alternate;
}

.stat-card {
  text-align: center;
  padding: 1rem;
}

.stat-icon {
  font-size: 2rem;
  margin-bottom: 0.5rem;
}

.stat-number {
  font-size: 1.8rem;
  font-weight: bold;
}

.glow-button {
  box-shadow: 0 0 20px rgba(25, 135, 84, 0.5);
  transition: all 0.3s ease;
}

.glow-button:hover {
  box-shadow: 0 0 30px rgba(25, 135, 84, 0.7);
  transform: translateY(-2px);
}

/* Secciones */
.streak-section-card {
  background: white;
  border-radius: 15px;
  padding: 1.5rem;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.section-header {
  border-bottom: 2px solid #f8f9fa;
  padding-bottom: 1rem;
  margin-bottom: 1.5rem;
}

/* Calendario */
.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 5px;
  text-align: center;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
  font-weight: 600;
  font-size: 0.9rem;
  position: relative;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.calendar-day.completed {
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  transform: scale(1.05);
}

.calendar-day.current {
  background: #198754;
  color: white;
  border-color: #198754;
  box-shadow: 0 0 10px rgba(25, 135, 84, 0.5);
}

.calendar-day.future {
  background: #f8f9fa;
  color: #6c757d;
  border-color: #e9ecef;
}

.calendar-day.missed {
  background: #f8f9fa;
  color: #dc3545;
  border: 2px dashed #dc3545;
}

.calendar-day.other-month {
  background: #f8f9fa;
  color: #adb5bd;
  opacity: 0.5;
}

.calendar-day:hover:not(.completed):not(.current) {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.day-check {
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 0.7rem;
}

.calendar-legend {
  padding-top: 1rem;
  border-top: 1px solid #e9ecef;
}

.legend-item {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.legend-color {
  width: 20px;
  height: 20px;
  border-radius: 5px;
  border: 2px solid transparent;
}

.legend-color.completed {
  background: linear-gradient(135deg, #28a745, #20c997);
}

.legend-color.current {
  background: #198754;
  border-color: #198754;
}

.legend-color.future {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
}

.legend-color.missed {
  background: #f8f9fa;
  border: 2px dashed #dc3545;
}

/* Barras de progreso */
.progress-bars-container {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.progress-item {
  margin-bottom: 0.5rem;
}

.progress {
  height: 10px;
  border-radius: 10px;
  overflow: hidden;
}

/* Hitos y logros */
.milestones-container,
.achievements-container {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.milestone-item {
  padding: 1rem;
  border-radius: 10px;
  border: 2px solid #e9ecef;
  transition: all 0.3s ease;
}

.milestone-item.achieved {
  border-color: #ffc107;
  background: rgba(255, 193, 7, 0.05);
}

.milestone-item.upcoming {
  border-color: #198754;
  background: rgba(25, 135, 84, 0.05);
}

.milestone-header {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.milestone-icon {
  font-size: 1.5rem;
  color: #6c757d;
}

.milestone-item.achieved .milestone-icon {
  color: #ffc107;
}

.achievement-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  border-radius: 10px;
  border: 2px solid #e9ecef;
  transition: all 0.3s ease;
}

.achievement-item.unlocked {
  border-color: #ffc107;
  background: rgba(255, 193, 7, 0.05);
}

.achievement-icon {
  font-size: 1.8rem;
}

.achievement-info {
  flex: 1;
}

.achievement-badge {
  color: #28a745;
  font-size: 1.2rem;
}

/* Acciones */
.actions-container {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

/* Tips */
.tip-content {
  padding: 1rem;
  background: rgba(13, 202, 240, 0.05);
  border-radius: 10px;
  border-left: 4px solid #0dcaf0;
}

/* Modal de estadÃ­sticas */
.stat-card-modal {
  text-align: center;
  padding: 1.5rem;
  border: 2px solid #f8f9fa;
  border-radius: 10px;
  background: #f8f9fa;
}

/* Responsive */
@media (max-width: 768px) {
  .streak-flame-main {
    font-size: 3rem;
  }
  
  .display-2 {
    font-size: 3rem;
  }
  
  .stat-number {
    font-size: 1.5rem;
  }
  
  .calendar-day {
    font-size: 0.8rem;
  }
  
  .streak-section-card {
    padding: 1rem;
  }
}

/* Animaciones para botones */
.btn {
  transition: all 0.3s ease;
}

.btn:active {
  transform: scale(0.98);
}

/* Mejoras de accesibilidad */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
</style>
{% endblock %}
