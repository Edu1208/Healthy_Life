{% extends "base.html" %}
{% block title %}Mi Racha - Healthy Life{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Header de Racha -->
  <div class="row justify-content-center mb-5">
    <div class="col-lg-8">
      <div class="streak-card bg-white p-4 text-center">
        <div class="streak-flame mb-3">
          <i class="bi bi-fire"></i>
        </div>

        <h1 class="display-4 fw-bold text-warning mb-2" id="diasConsecutivos">0</h1>
        <h3 class="text-dark mb-3">DÃ­as Consecutivos</h3>

        <p class="text-muted mb-4" id="mensajeRacha">Cargando tu progreso...</p>

        <div class="row text-center">
          <div class="col-4 border-end">
            <h4 class="text-success mb-1" id="rachaActual">0</h4>
            <small class="text-muted">Racha Actual</small>
          </div>
          <div class="col-4 border-end">
            <h4 class="text-primary mb-1" id="recordPersonal">0</h4>
            <small class="text-muted">RÃ©cord Personal</small>
          </div>
          <div class="col-4">
            <h4 class="text-info mb-1" id="tasaExito">0%</h4>
            <small class="text-muted">Tasa de Ã©xito</small>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="row g-4">

    <!-- Calendario -->
    <div class="col-lg-8">
      <div class="streak-card bg-white p-4">

        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="mb-0"><i class="bi bi-calendar3 text-primary me-2"></i>Calendario</h4>
          <span class="badge bg-success" id="mesActual">Cargando...</span>
        </div>

        <!-- DÃ­as semana -->
        <div class="row text-center mb-2">
          <div class="col fw-bold text-muted">L</div>
          <div class="col fw-bold text-muted">M</div>
          <div class="col fw-bold text-muted">M</div>
          <div class="col fw-bold text-muted">J</div>
          <div class="col fw-bold text-muted">V</div>
          <div class="col fw-bold text-muted">S</div>
          <div class="col fw-bold text-muted">D</div>
        </div>

        <div id="calendarioContainer"></div>

        <!-- Leyenda -->
        <div class="row text-center mt-4">
          <div class="col">
            <div class="d-flex justify-content-center align-items-center">
              <div class="calendar-square bg-success me-2"></div>
              <span>Completado</span>
            </div>
          </div>
          <div class="col">
            <div class="d-flex justify-content-center align-items-center">
              <div class="calendar-square border border-primary me-2"></div>
              <span>Hoy</span>
            </div>
          </div>
          <div class="col">
            <div class="d-flex justify-content-center align-items-center">
              <div class="calendar-square bg-light me-2"></div>
              <span>PrÃ³ximo</span>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Tarjetas adicionales -->
    <div class="col-lg-4">

      <!-- Hitos -->
      <div class="streak-card bg-white p-4 mb-4">
        <h5 class="mb-3"><i class="bi bi-flag text-success me-2"></i>PrÃ³ximos Hitos</h5>
        <div id="listaHitos">Cargando...</div>
      </div>

      <!-- EstadÃ­sticas -->
      <div class="streak-card bg-white p-4">
        <h5 class="mb-3"><i class="bi bi-graph-up text-info me-2"></i>EstadÃ­sticas</h5>

        <div class="mb-3">
          <div class="d-flex justify-content-between">
            <small>Consistencia mensual</small>
            <small id="consistenciaMensual">0%</small>
          </div>
          <div class="progress" style="height:5px;">
            <div class="progress-bar bg-success" id="barraConsistencia" style="width:0%"></div>
          </div>
        </div>

        <div class="mb-3">
          <div class="d-flex justify-content-between">
            <small>DÃ­as activos</small>
            <small id="diasActivos">0</small>
          </div>
          <div class="progress" style="height:5px;">
            <div class="progress-bar bg-primary" id="barraDiasActivos" style="width:0%"></div>
          </div>
        </div>

      </div>

      <!-- Acciones -->
      <div class="streak-card bg-white p-4 mt-4">
        <h5 class="mb-3"><i class="bi bi-lightning-charge text-warning me-2"></i>Acciones</h5>

        <button class="btn btn-success w-100 mb-2" onclick="marcarHoy()">
          <i class="bi bi-check-circle me-2"></i>Marcar Hoy
        </button>

        <button class="btn btn-outline-info w-100" onclick="abrirModalRecordatorio()">
          <i class="bi bi-bell me-2"></i>Recordatorios
        </button>

      </div>

    </div>
  </div>
</div>

<!-- Modal Recordatorio -->
<div class="modal fade" id="modalRecordatorio" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Configurar Recordatorio</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <label class="form-label">Hora</label>
        <input type="time" class="form-control" id="recordatorioHora">

        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="recordatorioActivo">
          <label class="form-check-label">Recordatorio activo</label>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button class="btn btn-success" onclick="guardarRecordatorio()">Guardar</button>
      </div>

    </div>
  </div>
</div>

{% endblock %}
#comentario --- BLOQUE 2 ---

{% block scripts %}
<script>

let datos = {
  diasConsecutivos: 0,
  recordPersonal: 0,
  diasCompletados: [],
  fechaUltimoDia: null,
  hitos: [3,7,14,30,60,100],
  recordatorio: { hora: "19:00", activo: true }
};

document.addEventListener("DOMContentLoaded", () => {
  cargarRacha();
});


/* =============================
   ðŸ”¥ CARGAR Racha desde Flask
============================= */
async function cargarRacha() {
  try {
    const r = await fetch("/racha/datos");
    const data = await r.json();

    if (!data.success) {
      mostrarMensaje("Error cargando racha", "danger");
      return;
    }

    const racha = data.racha;

    datos.diasConsecutivos = racha.dias_consecutivos || 0;
    datos.recordPersonal = racha.record_personal || 0;
    datos.diasCompletados = racha.dias_completados || [];
    datos.fechaUltimoDia = racha.fecha_ultimo_dia || null;
    datos.recordatorio = racha.recordatorio || datos.recordatorio;

    actualizarVistaRacha();
    generarCalendario();
    actualizarHitos();
    actualizarEstadisticas();

  } catch (e) {
    mostrarMensaje("Error de servidor", "danger");
  }
}


/* =============================
   ðŸ”¥ ACTUALIZAR INFORMACIÃ“N
============================= */
function actualizarVistaRacha() {
  const dias = datos.diasConsecutivos;
  document.getElementById("diasConsecutivos").textContent = dias;
  document.getElementById("rachaActual").textContent = dias;
  document.getElementById("recordPersonal").textContent = datos.recordPersonal;

  let msg = "";
  if (dias === 0) msg = "Â¡Comienza hoy!";
  else if (dias < 7) msg = "Â¡Buen inicio!";
  else if (dias < 30) msg = "ðŸ”¥ Sigues fuerte!";
  else msg = "ðŸŒŸ Eres imparable!";

  document.getElementById("mensajeRacha").textContent = msg;

  document.getElementById("tasaExito").textContent = calcularTasa() + "%";
}

function calcularTasa() {
  const fechas = datos.diasCompletados.map(d => new Date(d));
  if (fechas.length === 0) return 0;

  const primero = Math.min(...fechas);
  const inicio = new Date(primero);
  const hoy = new Date();

  const diff = Math.floor((hoy - inicio) / (1000*60*60*24)) + 1;
  return Math.round((fechas.length / diff) * 100);
}


/* =============================
   ðŸ”¥ GENERAR CALENDARIO
============================= */
function generarCalendario() {
  const container = document.getElementById("calendarioContainer");
  container.innerHTML = "";

  const hoy = new Date();
  const Y = hoy.getFullYear();
  const M = hoy.getMonth();

  const inicio = new Date(Y, M, 1);
  const inicioSemana = inicio.getDay() === 0 ? 6 : inicio.getDay()-1;
  inicio.setDate(inicio.getDate() - inicioSemana);

  document.getElementById("mesActual").textContent = hoy.toLocaleDateString("es-ES", {month:"long",year:"numeric"});

  let fecha = new Date(inicio);

  for (let s=0; s<6; s++) {
    let row = '<div class="row text-center mb-2">';

    for (let d=0; d<7; d++) {
      const fechaISO = fecha.toISOString().slice(0,10);
      const esHoy = fechaISO === hoy.toISOString().slice(0,10);
      const completado = datos.diasCompletados.includes(fechaISO);
      const futuro = fecha > hoy;

      let clase = "calendar-day";
      if (completado) clase += " bg-success text-white";
      else if (esHoy) clase += " border border-primary";
      else if (futuro) clase += " bg-light";

      row += `
        <div class="col">
          <div class="${clase}" ${esHoy && !completado ? 'onclick="marcarHoy()"' : ''}>
            ${fecha.getDate()}
          </div>
        </div>
      `;

      fecha.setDate(fecha.getDate() + 1);
    }

    row += "</div>";
    container.innerHTML += row;
  }
}


/* =============================
   ðŸ”¥ MARCAR EL DÃA
============================= */
async function marcarHoy() {
  try {
    const r = await fetch("/racha/marcar-dia", { method: "POST" });
    const data = await r.json();

    if (!data.success) {
      mostrarMensaje(data.message, "warning");
      return;
    }

    mostrarMensaje("Â¡DÃ­a registrado!", "success");
    cargarRacha();

  } catch (e) {
    mostrarMensaje("Error al marcar", "danger");
  }
}


/* =============================
   ðŸ”¥ EstadÃ­sticas
============================= */
function actualizarEstadisticas() {
  const hoy = new Date();
  const Y = hoy.getFullYear();
  const M = hoy.getMonth();
  const diasMes = new Date(Y, M+1, 0).getDate();

  const activos = datos.diasCompletados.filter(f => {
    const d = new Date(f);
    return d.getFullYear() === Y && d.getMonth() === M;
  }).length;

  document.getElementById("diasActivos").textContent = activos;
  document.getElementById("barraDiasActivos").style.width = (activos / diasMes * 100) + "%";

  const consistencia = Math.round((activos / hoy.getDate()) * 100);
  document.getElementById("consistenciaMensual").textContent = consistencia + "%";
  document.getElementById("barraConsistencia").style.width = consistencia + "%";
}


/* =============================
   ðŸ”¥ Hitos
============================= */
function actualizarHitos() {
  const c = document.getElementById("listaHitos");
  c.innerHTML = "";

  datos.hitos.forEach(h => {
    const resta = h - datos.diasConsecutivos;
    const pct = Math.min(100, Math.round((datos.diasConsecutivos / h) * 100));

    c.innerHTML += `
      <div class="p-2 mb-2 bg-light rounded">
        <div class="d-flex justify-content-between">
          <strong>${h} dÃ­as</strong>
          <span>${pct}%</span>
        </div>
        <div class="progress mt-1" style="height:5px;">
          <div class="progress-bar bg-success" style="width:${pct}%"></div>
        </div>
        <small class="text-muted">${resta > 0 ? resta + " dÃ­as restantes" : "Â¡Hito alcanzado!"}</small>
      </div>
    `;
  });
}


/* =============================
   ðŸ”” RECORDATORIO
============================= */
function abrirModalRecordatorio() {
  document.getElementById("recordatorioHora").value = datos.recordatorio.hora;
  document.getElementById("recordatorioActivo").checked = datos.recordatorio.activo;

  new bootstrap.Modal(document.getElementById("modalRecordatorio")).show();
}

async function guardarRecordatorio() {
  const hora = document.getElementById("recordatorioHora").value;
  const activo = document.getElementById("recordatorioActivo").checked;

  try {
    const r = await fetch("/racha/actualizar-recordatorio", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        hora,
        activo,
        frecuencia:"diario"
      })
    });

    const data = await r.json();
    mostrarMensaje(data.message || "Guardado", "success");

    bootstrap.Modal.getInstance(document.getElementById("modalRecordatorio")).hide();

    cargarRacha();

  } catch(e) {
    mostrarMensaje("Error guardando recordatorio", "danger");
  }
}


/* =============================
   ðŸ“¢ ALERTAS
============================= */
function mostrarMensaje(msg, tipo) {
  const a = document.createElement("div");
  a.className = `alert alert-${tipo} position-fixed top-0 end-0 mt-3 me-3`;
  a.textContent = msg;
  document.body.appendChild(a);

  setTimeout(() => a.remove(), 3000);
}

</script>

<style>
/* ESTILOS CALENDARIO */
.calendar-day {
  width: 38px;
  height: 38px;
  margin: auto;
  border-radius: 8px;
  line-height: 38px;
  font-size: 0.9rem;
  cursor: default;
}
.calendar-day:hover {
  opacity: .8;
  cursor: pointer;
}
.calendar-square {
  width: 20px;
  height: 20px;
  border-radius: 5px;
}
/* Tarjetas */
.streak-card {
  border-radius: 14px;
  box-shadow: 0 4px 10px rgba(0,0,0,.05);
}
.streak-flame i {
  font-size: 3rem;
  color: #fd7e14;
}
</style>

{% endblock %}

