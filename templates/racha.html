{% extends "base.html" %}
{% block title %}Mi Racha - Healthy Life{% endblock %}
{% block content %}
<div class="container py-4">
  <!-- Header de Racha -->
  <div class="row justify-content-center mb-5">
    <div class="col-lg-8">
      <div class="streak-card bg-white p-4 text-center">
        <div class="streak-flame mb-3">
          <i class="bi bi-fire"></i>
        </div>
        <h1 class="display-4 fw-bold text-warning mb-2" id="diasConsecutivos">{{ racha.dias_consecutivos if racha else 0 }}</h1>
        <h3 class="text-dark mb-3">DÃ­as Consecutivos</h3>
        <p class="text-muted mb-4" id="mensajeRacha">
          {% if racha and racha.dias_consecutivos == 0 %}
            Â¡Comienza tu racha hoy mismo!
          {% elif racha and racha.dias_consecutivos < 7 %}
            Â¡Sigue asÃ­! EstÃ¡s construyendo un hÃ¡bito increÃ­ble.
          {% elif racha and racha.dias_consecutivos < 30 %}
            Â¡Excelente trabajo! Tu consistencia es admirable.
          {% else %}
            Â¡Eres una mÃ¡quina! Sigue rompiendo tus lÃ­mites.
          {% endif %}
        </p>
        
        <div class="row text-center">
          <div class="col-md-4">
            <div class="border-end">
              <h4 class="text-success mb-1" id="rachaActual">{{ racha.dias_consecutivos if racha else 0 }}</h4>
              <small class="text-muted">Racha Actual</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="border-end">
              <h4 class="text-primary mb-1" id="recordPersonal">{{ racha.record_personal if racha else 0 }}</h4>
              <small class="text-muted">RÃ©cord Personal</small>
            </div>
          </div>
          <div class="col-md-4">
            <h4 class="text-info mb-1" id="tasaExito">0%</h4>
            <small class="text-muted">Tasa de Ã‰xito</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Calendario de Racha -->
    <div class="col-lg-8">
      <div class="streak-card bg-white p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="mb-0">
            <i class="bi bi-calendar3 text-primary me-2"></i>Calendario de Progreso
          </h4>
          <span class="badge bg-success" id="mesActual">Cargando...</span>
        </div>

        <!-- DÃ­as de la semana -->
        <div class="row text-center mb-3">
          <div class="col"><small class="text-muted fw-bold">L</small></div>
          <div class="col"><small class="text-muted fw-bold">M</small></div>
          <div class="col"><small class="text-muted fw-bold">M</small></div>
          <div class="col"><small class="text-muted fw-bold">J</small></div>
          <div class="col"><small class="text-muted fw-bold">V</small></div>
          <div class="col"><small class="text-muted fw-bold">S</small></div>
          <div class="col"><small class="text-muted fw-bold">D</small></div>
        </div>

        <div id="calendarioContainer">
          <!-- El calendario se generarÃ¡ dinÃ¡micamente -->
        </div>

        <!-- Leyenda -->
        <div class="row mt-4 text-center">
          <div class="col-md-4">
            <div class="d-flex align-items-center justify-content-center">
              <div class="calendar-day completed me-2"></div>
              <small>Completado</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="d-flex align-items-center justify-content-center">
              <div class="calendar-day current me-2"></div>
              <small>Hoy</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="d-flex align-items-center justify-content-center">
              <div class="calendar-day future me-2"></div>
              <small>PrÃ³ximo</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PrÃ³ximos Hitos y EstadÃ­sticas -->
    <div class="col-lg-4">
      <!-- PrÃ³ximos Hitos -->
      <div class="streak-card bg-white p-4 mb-4">
        <h5 class="mb-4">
          <i class="bi bi-flag text-success me-2"></i>PrÃ³ximos Hitos
        </h5>
        <div id="listaHitos">
          <!-- Los hitos se cargarÃ¡n dinÃ¡micamente -->
        </div>
      </div>

      <!-- EstadÃ­sticas de Racha -->
      <div class="streak-card bg-white p-4">
        <h5 class="mb-4">
          <i class="bi bi-graph-up text-info me-2"></i>EstadÃ­sticas
        </h5>
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <small>Consistencia Mensual</small>
            <small id="consistenciaMensual">0%</small>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-success" id="barraConsistencia" style="width: 0%"></div>
          </div>
        </div>
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <small>DÃ­as Activos</small>
            <small id="diasActivos">0/0</small>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-primary" id="barraDiasActivos" style="width: 0%"></div>
          </div>
        </div>
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <small>Metas Alcanzadas</small>
            <small id="metasAlcanzadas">0/0</small>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-warning" id="barraMetas" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- Acciones RÃ¡pidas -->
      <div class="streak-card bg-white p-4 mt-4">
        <h5 class="mb-3">
          <i class="bi bi-lightning text-warning me-2"></i>Acciones
        </h5>
        <div class="d-grid gap-2">
          <button class="btn btn-success" onclick="marcarDiaHoy()">
            <i class="bi bi-check-circle me-2"></i>Marcar Hoy
          </button>
          <button class="btn btn-outline-primary" onclick="compartirRacha()">
            <i class="bi bi-share me-2"></i>Compartir Racha
          </button>
          <button class="btn btn-outline-info" onclick="configurarRecordatorio()">
            <i class="bi bi-bell me-2"></i>Recordatorios
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de ConfiguraciÃ³n de Recordatorio -->
<div class="modal fade" id="modalRecordatorio" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Configurar Recordatorio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Hora del recordatorio</label>
          <input type="time" class="form-control" id="horaRecordatorio" value="{{ racha.recordatorio.hora if racha and racha.recordatorio else '19:00' }}">
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="recordatorioActivo" {% if racha and racha.recordatorio and racha.recordatorio.activo %}checked{% endif %}>
          <label class="form-check-label" for="recordatorioActivo">
            Recordatorio activo
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" onclick="guardarRecordatorio()">Guardar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let datosRacha = {{ racha|tojson if racha else '{}' }};

// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', function() {
  if (Object.keys(datosRacha).length === 0) {
    cargarDatosRacha();
  } else {
    actualizarRacha();
    generarCalendario();
    actualizarEstadisticas();
    actualizarHitos();
  }
});

function cargarDatosRacha() {
  fetch('/racha/datos')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        datosRacha = data.racha;
        actualizarRacha();
        generarCalendario();
        actualizarEstadisticas();
        actualizarHitos();
      } else {
        console.error('Error al cargar datos de racha:', data.message);
      }
    })
    .catch(error => {
      console.error('Error al cargar datos de racha:', error);
    });
}

function actualizarRacha() {
  // Actualizar interfaz con datos de la racha
  document.getElementById('diasConsecutivos').textContent = datosRacha.dias_consecutivos || 0;
  document.getElementById('rachaActual').textContent = datosRacha.dias_consecutivos || 0;
  document.getElementById('recordPersonal').textContent = datosRacha.record_personal || 0;
  
  // Actualizar mensaje motivacional
  const mensajeRacha = document.getElementById('mensajeRacha');
  const diasConsecutivos = datosRacha.dias_consecutivos || 0;
  
  if (diasConsecutivos === 0) {
    mensajeRacha.textContent = 'Â¡Comienza tu racha hoy mismo!';
  } else if (diasConsecutivos < 7) {
    mensajeRacha.textContent = 'Â¡Sigue asÃ­! EstÃ¡s construyendo un hÃ¡bito increÃ­ble.';
  } else if (diasConsecutivos < 30) {
    mensajeRacha.textContent = 'Â¡Excelente trabajo! Tu consistencia es admirable.';
  } else {
    mensajeRacha.textContent = 'Â¡Eres una mÃ¡quina! Sigue rompiendo tus lÃ­mites.';
  }
  
  // Actualizar tasa de Ã©xito
  const tasaExito = calcularTasaExito();
  document.getElementById('tasaExito').textContent = tasaExito + '%';
}

function marcarDiaHoy() {
  fetch('/racha/marcar-dia', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      mostrarMensaje(data.message, 'success');
      // Actualizar datos locales
      datosRacha.dias_consecutivos = data.nueva_racha;
      datosRacha.record_personal = data.record_personal;
      
      // Agregar dÃ­a actual a dÃ­as completados
      const hoy = new Date();
      const hoyStr = hoy.toISOString().split('T')[0];
      if (!datosRacha.dias_completados) {
        datosRacha.dias_completados = [];
      }
      if (!datosRacha.dias_completados.includes(hoyStr)) {
        datosRacha.dias_completados.push(hoyStr);
      }
      
      actualizarRacha();
      generarCalendario();
      actualizarEstadisticas();
      actualizarHitos();
    } else {
      mostrarMensaje(data.message, 'warning');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    mostrarMensaje('Error al marcar el dÃ­a', 'danger');
  });
}

function generarCalendario() {
  const container = document.getElementById('calendarioContainer');
  if (!container) return;
  
  const hoy = new Date();
  const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
  const ultimoDiaMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
  
  // Actualizar mes actual
  const mesActualElement = document.getElementById('mesActual');
  if (mesActualElement) {
    mesActualElement.textContent = hoy.toLocaleDateString('es-ES', { 
      month: 'long', 
      year: 'numeric' 
    });
  }
  
  let calendarioHTML = '';
  let fechaActual = new Date(primerDiaMes);
  
  // Ajustar para que empiece en lunes
  const diaSemana = primerDiaMes.getDay();
  const ajusteInicio = diaSemana === 0 ? 6 : diaSemana - 1;
  fechaActual.setDate(fechaActual.getDate() - ajusteInicio);
  
  // Generar 6 semanas
  for (let semana = 0; semana < 6; semana++) {
    calendarioHTML += '<div class="row text-center mt-2">';
    
    for (let dia = 0; dia < 7; dia++) {
      const fechaStr = fechaActual.toISOString().split('T')[0];
      const esHoy = fechaActual.toDateString() === hoy.toDateString();
      const esMesActual = fechaActual.getMonth() === hoy.getMonth();
      const completado = datosRacha.dias_completados && datosRacha.dias_completados.includes(fechaStr);
      const esFuturo = fechaActual > hoy;
      
      let claseDia = 'calendar-day';
      if (completado) {
        claseDia += ' completed';
      } else if (esHoy) {
        claseDia += ' current';
      } else if (esFuturo) {
        claseDia += ' future';
      } else if (!esMesActual) {
        claseDia += ' other-month';
      }
      
      const diaNumero = fechaActual.getDate();
      
      calendarioHTML += `
        <div class="col">
          <div class="${claseDia}" ${esHoy && !completado ? 'onclick="marcarDiaHoy()" style="cursor: pointer;"' : ''}>
            ${diaNumero}
          </div>
        </div>
      `;
      
      fechaActual.setDate(fechaActual.getDate() + 1);
    }
    
    calendarioHTML += '</div>';
    
    // Si ya pasamos el Ãºltimo dÃ­a del mes, salir
    if (fechaActual > ultimoDiaMes && fechaActual.getDate() > 20) {
      break;
    }
  }
  
  container.innerHTML = calendarioHTML;
}

function actualizarEstadisticas() {
  const hoy = new Date();
  const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
  const diasEnMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0).getDate();
  
  // Calcular dÃ­as activos este mes
  let diasActivosMes = 0;
  if (datosRacha.dias_completados) {
    diasActivosMes = datosRacha.dias_completados.filter(fecha => {
      const fechaObj = new Date(fecha);
      return fechaObj.getMonth() === hoy.getMonth() && 
             fechaObj.getFullYear() === hoy.getFullYear();
    }).length;
  }
  
  const diasTranscurridos = hoy.getDate();
  const consistencia = diasTranscurridos > 0 ? 
    Math.round((diasActivosMes / diasTranscurridos) * 100) : 0;
  
  const porcentajeDiasActivos = Math.round((diasActivosMes / diasEnMes) * 100);
  
  // Metas (simuladas)
  const metasTotales = 15;
  const metasCompletadas = Math.min(Math.round(diasActivosMes * 0.8), metasTotales);
  
  // Actualizar elementos
  document.getElementById('consistenciaMensual').textContent = consistencia + '%';
  document.getElementById('barraConsistencia').style.width = consistencia + '%';
  
  document.getElementById('diasActivos').textContent = `${diasActivosMes}/${diasEnMes}`;
  document.getElementById('barraDiasActivos').style.width = porcentajeDiasActivos + '%';
  
  document.getElementById('metasAlcanzadas').textContent = `${metasCompletadas}/${metasTotales}`;
  document.getElementById('barraMetas').style.width = Math.round((metasCompletadas / metasTotales) * 100) + '%';
}

function actualizarHitos() {
  const listaHitos = document.getElementById('listaHitos');
  if (!listaHitos) return;
  
  listaHitos.innerHTML = '';
  
  const hitos = datosRacha.hitos || [7, 14, 30, 60, 90];
  const diasConsecutivos = datosRacha.dias_consecutivos || 0;
  
  hitos.forEach(hito => {
    const diasRestantes = hito - diasConsecutivos;
    const porcentaje = Math.min(Math.round((diasConsecutivos / hito) * 100), 100);
    
    const hitoHTML = `
      <div class="milestone-badge mb-3">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h6 class="text-success mb-0">${hito} dÃ­as</h6>
          <span class="badge bg-success">${porcentaje}%</span>
        </div>
        <small class="text-muted">${diasRestantes > 0 ? diasRestantes + ' dÃ­as restantes' : 'Â¡Hito alcanzado!'}</small>
        <div class="progress mt-1" style="height: 4px;">
          <div class="progress-bar bg-success" style="width: ${porcentaje}%"></div>
        </div>
      </div>
    `;
    
    listaHitos.innerHTML += hitoHTML;
  });
}

function calcularTasaExito() {
  if (!datosRacha.dias_completados || datosRacha.dias_completados.length === 0) return 0;
  
  const fechas = datosRacha.dias_completados.map(d => new Date(d));
  const primerDia = new Date(Math.min(...fechas));
  const hoy = new Date();
  const diasTotales = Math.ceil((hoy - primerDia) / (1000 * 60 * 60 * 24)) + 1;
  
  return Math.round((datosRacha.dias_completados.length / diasTotales) * 100);
}

function compartirRacha() {
  const diasConsecutivos = datosRacha.dias_consecutivos || 0;
  const recordPersonal = datosRacha.record_personal || 0;
  
  const texto = `Â¡Llevo ${diasConsecutivos} dÃ­as consecutivos entrenando con Healthy Life! ðŸ’ª\nMi rÃ©cord personal: ${recordPersonal} dÃ­as.\n\nÂ¡Ãšnete a mi desafÃ­o! #HealthyLife #Fitness`;
  
  if (navigator.share) {
    navigator.share({
      title: 'Mi Racha de Entrenamiento',
      text: texto,
      url: window.location.href
    });
  } else {
    navigator.clipboard.writeText(texto).then(() => {
      mostrarMensaje('Â¡Texto copiado al portapapeles! Comparte tu logro.', 'success');
    });
  }
}

function configurarRecordatorio() {
  const modalElement = document.getElementById('modalRecordatorio');
  if (!modalElement) return;
  
  const horaInput = document.getElementById('horaRecordatorio');
  const activoInput = document.getElementById('recordatorioActivo');
  
  if (horaInput) horaInput.value = datosRacha.recordatorio ? datosRacha.recordatorio.hora : '19:00';
  if (activoInput) activoInput.checked = datosRacha.recordatorio ? datosRacha.recordatorio.activo : true;
  
  const modal = new bootstrap.Modal(modalElement);
  modal.show();
}

function guardarRecordatorio() {
  const horaInput = document.getElementById('horaRecordatorio');
  const activoInput = document.getElementById('recordatorioActivo');
  
  const recordatorio = {
    activo: activoInput ? activoInput.checked : true,
    hora: horaInput ? horaInput.value : '19:00'
  };

  fetch('/racha/actualizar-recordatorio', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(recordatorio)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      mostrarMensaje(data.message, 'success');
      // Actualizar datos locales
      if (!datosRacha.recordatorio) {
        datosRacha.recordatorio = {};
      }
      datosRacha.recordatorio.activo = recordatorio.activo;
      datosRacha.recordatorio.hora = recordatorio.hora;
    } else {
      mostrarMensaje(data.message, 'danger');
    }
    
    const modalElement = document.getElementById('modalRecordatorio');
    if (modalElement) {
      const modal = bootstrap.Modal.getInstance(modalElement);
      if (modal) modal.hide();
    }
  })
  .catch(error => {
    console.error('Error:', error);
    mostrarMensaje('Error al actualizar el recordatorio', 'danger');
  });
}

function mostrarMensaje(mensaje, tipo) {
  const alerta = document.createElement('div');
  alerta.className = `alert alert-${tipo} alert-dismissible fade show`;
  alerta.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
  alerta.innerHTML = `
    ${mensaje}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(alerta);
  
  setTimeout(() => {
    if (alerta.parentNode) {
      alerta.remove();
    }
  }, 3000);
}
</script>

<style>
.streak-card {
  border: none;
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.05);
  padding: 2rem;
  background: white;
}

.streak-flame {
  font-size: 4rem;
  background: linear-gradient(135deg, #ff6b00, #ffd700);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.calendar-day {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 2px auto;
  font-size: 0.875rem;
  transition: all 0.3s ease;
  font-weight: 500;
  border: 2px solid transparent;
}

.calendar-day.completed {
  background: linear-gradient(135deg, #ffd700, #ff6b00);
  color: white;
}

.calendar-day.current {
  background: #198754;
  color: white;
  transform: scale(1.1);
  border-color: #198754;
}

.calendar-day.future {
  background: #f8f9fa;
  color: #6c757d;
  border-color: #e9ecef;
}

.calendar-day.other-month {
  background: #f8f9fa;
  color: #6c757d;
  opacity: 0.5;
}

.calendar-day:hover {
  transform: scale(1.05);
}

.milestone-badge {
  border-left: 4px solid #198754;
  padding-left: 1rem;
  margin-bottom: 1.5rem;
}

.progress {
  height: 8px;
  border-radius: 4px;
}
</style>
{% endblock %}
