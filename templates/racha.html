{% extends "base.html" %}
{% block title %}Mi Racha - Healthy Life{% endblock %}
{% block content %}
<div class="container py-4">
  <!-- Header de Racha -->
  <div class="row justify-content-center mb-5">
    <div class="col-lg-8">
      <div class="streak-card bg-white p-4 text-center rounded shadow">
        <div class="streak-flame mb-3">
          <i class="bi bi-fire text-warning" style="font-size: 4rem;"></i>
        </div>
        <h1 class="display-4 fw-bold text-warning mb-2" id="diasConsecutivos">0</h1>
        <h3 class="text-dark mb-3">DÃ­as Consecutivos</h3>
        <p class="text-muted mb-4" id="mensajeRacha">Â¡Comienza tu racha hoy mismo!</p>
        
        <div class="row text-center">
          <div class="col-md-4">
            <div class="border-end">
              <h4 class="text-success mb-1" id="rachaActual">0</h4>
              <small class="text-muted">Racha Actual</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="border-end">
              <h4 class="text-primary mb-1" id="recordPersonal">0</h4>
              <small class="text-muted">RÃ©cord Personal</small>
            </div>
          </div>
          <div class="col-md-4">
            <h4 class="text-info mb-1" id="tasaExito">0%</h4>
            <small class="text-muted">Tasa de Ã‰xito</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Calendario de Racha -->
    <div class="col-lg-8">
      <div class="streak-card bg-white p-4 rounded shadow">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="mb-0">
            <i class="bi bi-calendar3 text-primary me-2"></i>Calendario de Progreso
          </h4>
          <span class="badge bg-success" id="mesActual">{{ now.strftime('%B %Y') }}</span>
        </div>

        <!-- DÃ­as de la semana -->
        <div class="row text-center mb-3">
          <div class="col"><small class="text-muted fw-bold">L</small></div>
          <div class="col"><small class="text-muted fw-bold">M</small></div>
          <div class="col"><small class="text-muted fw-bold">M</small></div>
          <div class="col"><small class="text-muted fw-bold">J</small></div>
          <div class="col"><small class="text-muted fw-bold">V</small></div>
          <div class="col"><small class="text-muted fw-bold">S</small></div>
          <div class="col"><small class="text-muted fw-bold">D</small></div>
        </div>

        <div id="calendarioContainer">
          <!-- El calendario se generarÃ¡ dinÃ¡micamente -->
        </div>

        <!-- Leyenda -->
        <div class="row mt-4 text-center">
          <div class="col-md-4">
            <div class="d-flex align-items-center justify-content-center">
              <div class="calendar-day completed me-2"></div>
              <small>Completado</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="d-flex align-items-center justify-content-center">
              <div class="calendar-day current me-2"></div>
              <small>Hoy</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="d-flex align-items-center justify-content-center">
              <div class="calendar-day future me-2"></div>
              <small>PrÃ³ximo</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PrÃ³ximos Hitos y EstadÃ­sticas -->
    <div class="col-lg-4">
      <!-- PrÃ³ximos Hitos -->
      <div class="streak-card bg-white p-4 mb-4 rounded shadow">
        <h5 class="mb-4">
          <i class="bi bi-flag text-success me-2"></i>PrÃ³ximos Hitos
        </h5>
        <div id="listaHitos">
          <!-- Los hitos se cargarÃ¡n dinÃ¡micamente -->
        </div>
      </div>

      <!-- EstadÃ­sticas de Racha -->
      <div class="streak-card bg-white p-4 mb-4 rounded shadow">
        <h5 class="mb-4">
          <i class="bi bi-graph-up text-info me-2"></i>EstadÃ­sticas
        </h5>
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <small>Consistencia Mensual</small>
            <small id="consistenciaMensual">0%</small>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-success" id="barraConsistencia" style="width: 0%"></div>
          </div>
        </div>
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <small>DÃ­as Activos</small>
            <small id="diasActivos">0/0</small>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-primary" id="barraDiasActivos" style="width: 0%"></div>
          </div>
        </div>
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <small>Metas Alcanzadas</small>
            <small id="metasAlcanzadas">0/0</small>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-warning" id="barraMetas" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- Acciones RÃ¡pidas -->
      <div class="streak-card bg-white p-4 rounded shadow">
        <h5 class="mb-3">
          <i class="bi bi-lightning text-warning me-2"></i>Acciones
        </h5>
        <div class="d-grid gap-2">
          <button class="btn btn-success" onclick="marcarDiaHoy()">
            <i class="bi bi-check-circle me-2"></i>Marcar Hoy
          </button>
          <button class="btn btn-outline-primary" onclick="compartirRacha()">
            <i class="bi bi-share me-2"></i>Compartir Racha
          </button>
          <a href="{{ url_for('nuevo') }}" class="btn btn-outline-info">
            <i class="bi bi-plus-circle me-2"></i>Nueva Rutina
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', function() {
  cargarDatosRacha();
});

function cargarDatosRacha() {
  fetch('/racha/datos')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        actualizarRacha(data.racha);
      } else {
        console.error('Error al cargar racha:', data.message);
        // Fallback a datos vacÃ­os
        actualizarRacha({
          diasConsecutivos: 0,
          recordPersonal: 0,
          diasCompletados: [],
          fechaUltimoDia: null
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      // Fallback a datos vacÃ­os
      actualizarRacha({
        diasConsecutivos: 0,
        recordPersonal: 0,
        diasCompletados: [],
        fechaUltimoDia: null
      });
    });
}

function actualizarRacha(datosRacha) {
  document.getElementById('diasConsecutivos').textContent = datosRacha.diasConsecutivos;
  document.getElementById('rachaActual').textContent = datosRacha.diasConsecutivos;
  document.getElementById('recordPersonal').textContent = datosRacha.recordPersonal;
  
  // Actualizar mensaje motivacional
  const mensajeRacha = document.getElementById('mensajeRacha');
  if (datosRacha.diasConsecutivos === 0) {
    mensajeRacha.textContent = 'Â¡Comienza tu racha hoy mismo!';
  } else if (datosRacha.diasConsecutivos < 7) {
    mensajeRacha.textContent = 'Â¡Sigue asÃ­! EstÃ¡s construyendo un hÃ¡bito increÃ­ble.';
  } else if (datosRacha.diasConsecutivos < 30) {
    mensajeRacha.textContent = 'Â¡Excelente trabajo! Tu consistencia es admirable.';
  } else {
    mensajeRacha.textContent = 'Â¡Eres una mÃ¡quina! Sigue rompiendo tus lÃ­mites.';
  }
  
  // Actualizar tasa de Ã©xito
  const tasaExito = calcularTasaExito(datosRacha.diasCompletados);
  document.getElementById('tasaExito').textContent = tasaExito + '%';
  
  // Generar calendario y estadÃ­sticas
  generarCalendario(datosRacha.diasCompletados);
  actualizarEstadisticas(datosRacha.diasCompletados);
  actualizarHitos(datosRacha.diasConsecutivos);
}

function marcarDiaHoy() {
  fetch('/racha/marcar-dia', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      mostrarMensaje(data.message, 'success');
      cargarDatosRacha();
    } else {
      mostrarMensaje(data.message, 'warning');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    mostrarMensaje('Error al marcar el dÃ­a', 'danger');
  });
}

function generarCalendario(diasCompletados) {
  const container = document.getElementById('calendarioContainer');
  const hoy = new Date();
  const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
  const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
  
  let calendarioHTML = '';
  let fechaActual = new Date(primerDia);
  
  // Ajustar para que empiece en lunes
  const diaSemana = primerDia.getDay();
  const ajusteInicio = diaSemana === 0 ? 6 : diaSemana - 1;
  fechaActual.setDate(fechaActual.getDate() - ajusteInicio);
  
  // Generar 6 semanas
  for (let semana = 0; semana < 6; semana++) {
    calendarioHTML += '<div class="row text-center mt-2">';
    
    for (let dia = 0; dia < 7; dia++) {
      const fechaStr = fechaActual.toDateString();
      const esHoy = fechaActual.toDateString() === hoy.toDateString();
      const esMesActual = fechaActual.getMonth() === hoy.getMonth();
      const completado = diasCompletados.includes(fechaStr);
      const esFuturo = fechaActual > hoy;
      
      let claseDia = 'calendar-day';
      if (completado) {
        claseDia += ' completed';
      } else if (esHoy) {
        claseDia += ' current';
      } else if (esFuturo) {
        claseDia += ' future';
      } else if (!esMesActual) {
        claseDia += ' other-month';
      }
      
      calendarioHTML += `
        <div class="col">
          <div class="${claseDia}" onclick="${esHoy && !completado ? 'marcarDiaHoy()' : ''}" style="${esHoy && !completado ? 'cursor: pointer;' : ''}">
            ${fechaActual.getDate()}
          </div>
        </div>
      `;
      
      fechaActual.setDate(fechaActual.getDate() + 1);
    }
    
    calendarioHTML += '</div>';
    
    // Si ya pasamos el Ãºltimo dÃ­a del mes, salir
    if (fechaActual > ultimoDia && fechaActual.getDate() > 20) {
      break;
    }
  }
  
  container.innerHTML = calendarioHTML;
}

function actualizarEstadisticas(diasCompletados) {
  const hoy = new Date();
  const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
  const diasEnMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0).getDate();
  
  // Calcular dÃ­as activos este mes
  const diasActivosMes = diasCompletados.filter(fecha => {
    const fechaObj = new Date(fecha);
    return fechaObj.getMonth() === hoy.getMonth() && fechaObj.getFullYear() === hoy.getFullYear();
  }).length;
  
  const consistencia = Math.round((diasActivosMes / hoy.getDate()) * 100);
  const porcentajeDiasActivos = Math.round((diasActivosMes / diasEnMes) * 100);
  
  document.getElementById('consistenciaMensual').textContent = consistencia + '%';
  document.getElementById('barraConsistencia').style.width = consistencia + '%';
  
  document.getElementById('diasActivos').textContent = `${diasActivosMes}/${diasEnMes}`;
  document.getElementById('barraDiasActivos').style.width = porcentajeDiasActivos + '%';
}

function actualizarHitos(diasConsecutivos) {
  const listaHitos = document.getElementById('listaHitos');
  const hitos = [7, 14, 30, 60, 90];
  
  listaHitos.innerHTML = '';
  
  hitos.forEach(hito => {
    const diasRestantes = hito - diasConsecutivos;
    const porcentaje = Math.min(Math.round((diasConsecutivos / hito) * 100), 100);
    const alcanzado = diasConsecutivos >= hito;
    
    const hitoHTML = `
      <div class="milestone-badge mb-3 p-3 rounded ${alcanzado ? 'bg-success bg-opacity-10' : 'bg-light'}">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h6 class="${alcanzado ? 'text-success' : 'text-dark'} mb-0">${hito} dÃ­as</h6>
          <span class="badge ${alcanzado ? 'bg-success' : 'bg-secondary'}">${porcentaje}%</span>
        </div>
        <small class="${alcanzado ? 'text-success' : 'text-muted'}">
          ${alcanzado ? 'Â¡Hito alcanzado! ðŸŽ‰' : (diasRestantes > 0 ? diasRestantes + ' dÃ­as restantes' : 'Â¡Casi ahÃ­!')}
        </small>
        <div class="progress mt-1" style="height: 4px;">
          <div class="progress-bar ${alcanzado ? 'bg-success' : 'bg-primary'}" style="width: ${porcentaje}%"></div>
        </div>
      </div>
    `;
    
    listaHitos.innerHTML += hitoHTML;
  });
}

function calcularTasaExito(diasCompletados) {
  if (diasCompletados.length === 0) return 0;
  
  const primerDia = new Date(Math.min(...diasCompletados.map(d => new Date(d))));
  const hoy = new Date();
  const diasTotales = Math.ceil((hoy - primerDia) / (1000 * 60 * 60 * 24)) + 1;
  
  return Math.round((diasCompletados.length / diasTotales) * 100);
}

function compartirRacha() {
  const diasConsecutivos = document.getElementById('diasConsecutivos').textContent;
  const recordPersonal = document.getElementById('recordPersonal').textContent;
  
  const texto = `Â¡Llevo ${diasConsecutivos} dÃ­as consecutivos entrenando con Healthy Life! ðŸ’ª\nMi rÃ©cord personal: ${recordPersonal} dÃ­as.\n\nÂ¡Ãšnete a mi desafÃ­o! #HealthyLife #Fitness`;
  
  if (navigator.share) {
    navigator.share({
      title: 'Mi Racha de Entrenamiento',
      text: texto,
      url: window.location.href
    });
  } else {
    // Fallback: copiar al portapapeles
    navigator.clipboard.writeText(texto).then(() => {
      mostrarMensaje('Â¡Texto copiado al portapapeles! Comparte tu logro.', 'success');
    });
  }
}

function mostrarMensaje(mensaje, tipo) {
  const alerta = document.createElement('div');
  alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
  alerta.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
  alerta.innerHTML = `
    ${mensaje}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(alerta);
  
  setTimeout(() => {
    if (alerta.parentNode) alerta.remove();
  }, 3000);
}
</script>

<style>
.streak-card {
  border: none;
}

.streak-flame {
  animation: flamePulse 2s ease-in-out infinite;
}

@keyframes flamePulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.calendar-day {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
  font-size: 0.875rem;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.calendar-day.completed {
  background-color: #198754;
  color: white;
  transform: scale(1.1);
}

.calendar-day.current {
  background-color: #ffc107;
  color: black;
  border-color: #ff6b35;
  font-weight: bold;
}

.calendar-day.future {
  background-color: #f8f9fa;
  color: #6c757d;
}

.calendar-day.other-month {
  background: #f8f9fa;
  color: #6c757d;
  opacity: 0.5;
}

.calendar-day:hover:not(.completed):not(.other-month) {
  background-color: #e9ecef;
  transform: scale(1.05);
}

.milestone-badge {
  transition: all 0.3s ease;
}

.milestone-badge:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %}
